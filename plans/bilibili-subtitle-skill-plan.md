# Bilibili Subtitle Extraction Skill - Solution Design

> Generated by all-plan collaborative design process

## Overview

**Goal**: Build a Claude Code skill that reliably extracts Bilibili subtitles (supporting both with/without subtitle paths) and generates structured transcripts with summaries.

**Readiness Score**: 88/100

**Generated**: 2026-01-22

---

## Requirements Summary

### Problem Statement

创建一个 Claude Code skill，用于提取 B站视频字幕并生成总结。支持两种路径：
1. 有 AI 字幕的视频：直接提取、校对、输出逐字稿
2. 无字幕视频：抓取音频、多模态模型转写、生成带时间轴字幕

### Scope

**In Scope**:
- B站视频字幕提取 (BV/av 号)
- 音频转写 (无字幕视频)
- 字幕校对与优化
- 内容摘要生成
- SRT/VTT/Markdown 输出
- 双语输出支持 (zh+en 单文件)

**Out of Scope**:
- 批量爬取
- 付费/会员专属内容破解
- 实时直播字幕

### Success Criteria

- [ ] Path A: 成功提取有字幕视频，输出 SRT/VTT 匹配 golden files
- [ ] Path B: 成功转写无字幕视频，生成严格递增时间戳的字幕
- [ ] 摘要输出符合 JSON schema，包含时间戳引用

### Constraints

- 必须遵守 B站平台政策
- 用户提供认证 (cookies)，不自动破解
- 优雅处理速率限制
- 使用 Claude Agent SDK 构建转写管道

### Assumptions

- 用户可提供有效的 B站 cookies (如需)
- 目标视频可通过 yt-dlp 访问
- Claude API 可用于转写和摘要

---

## Architecture

### Approach

采用双路径架构，根据视频是否有字幕自动选择处理路径：

```
┌──────────────────────────────────────────────────────────────┐
│                  bilibili-subtitle skill                      │
├──────────────────────────────────────────────────────────────┤
│  Entry: SKILL.md + python -m bilibili_subtitle               │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────┐   ┌─────────────────┐   ┌─────────────────┐   │
│  │URL Parser│──▶│SubtitleDetector │──▶│Path Selector    │   │
│  │(BV/av ID)│   │(yt-dlp metadata)│   │                 │   │
│  └──────────┘   └─────────────────┘   └────────┬────────┘   │
│                                                 │            │
│                        ┌────────────────────────┼────────┐   │
│                        ▼                        ▼        │   │
│                 ┌────────────┐          ┌────────────┐   │   │
│                 │  Path A    │          │  Path B    │   │   │
│                 │  Subtitle  │          │  Audio     │   │   │
│                 │  Extract   │          │  Transcribe│   │   │
│                 └─────┬──────┘          └─────┬──────┘   │   │
│                       │                       │          │   │
│                       └───────────┬───────────┘          │   │
│                                   ▼                      │   │
│                          ┌────────────────┐              │   │
│                          │  Proofreader   │              │   │
│                          │  (Claude)      │              │   │
│                          └───────┬────────┘              │   │
│                                  ▼                       │   │
│                          ┌────────────────┐              │   │
│                          │  Summarizer    │              │   │
│                          │  (Claude)      │              │   │
│                          └───────┬────────┘              │   │
│                                  ▼                       │   │
│                          ┌────────────────┐              │   │
│                          │  Output        │              │   │
│                          │  SRT/VTT/MD    │              │   │
│                          └────────────────┘              │   │
└──────────────────────────────────────────────────────────────┘
```

### Key Components

- **URL Parser**: 解析 BV/av 号，提取视频 ID
- **SubtitleDetector**: 使用 yt-dlp 检测可用字幕轨道
- **Path A (SubtitleExtractor)**: 下载并转换现有字幕
- **Path B (AudioTranscriber)**: 音频提取 + Claude Agent SDK 转写
- **Proofreader**: Claude 校对专有名词、错别字
- **Summarizer**: 生成结构化摘要
- **Renderer**: 输出 SRT/VTT/Markdown 格式

### Core Data Model

```python
@dataclass
class Segment:
    start_ms: int
    end_ms: int
    text: str

    # Invariants:
    # - start_ms < end_ms
    # - start_ms >= 0
    # - text is non-empty after strip
```

### SubtitleDetector Decision Table

| Condition | Action |
|-----------|--------|
| yt-dlp finds `ai-zh` subtitle | Path A (AI subtitle) |
| yt-dlp finds `zh` subtitle | Path A (official subtitle) |
| yt-dlp finds `zh-Hans` subtitle | Path A (simplified Chinese) |
| yt-dlp finds any subtitle | Path A (fallback) |
| No subtitle found | Path B (audio transcription) |

**Priority**: ai-zh > zh > zh-Hans > any > Path B

---

## Implementation Plan

### Step 1: URL Parsing + Metadata Extraction

- **Actions**:
  - 实现 BV/av 号解析器
  - 集成 yt-dlp `extract_info(download=False)`
  - 定义 `Segment` 数据模型
  - 实现字幕轨道检测逻辑
- **Deliverables**: `url_parser.py`, `segment.py`, `detector.py`
- **Dependencies**: yt-dlp 安装

### Step 2: Subtitle Discovery & Converters

- **Actions**:
  - 实现 yt-dlp 字幕下载 (`--write-subs --sub-lang zh,ai-zh`)
  - 实现 JSON → Segment 转换器
  - 实现 ASS → Segment 转换器
  - 添加字幕语言映射层
- **Deliverables**: `subtitle_downloader.py`, `converters/json_converter.py`, `converters/ass_converter.py`
- **Dependencies**: Step 1

### Step 3: Path A - Proofreading Agent

- **Actions**:
  - 使用 Claude Agent SDK 创建 ProofreadAgent
  - 定义校对 prompt (仅修改文本，保留时间戳)
  - 实现 diff 输出用于审计
- **Deliverables**: `agents/proofread_agent.py`
- **Dependencies**: Step 2, Claude Agent SDK

### Step 4: Path B - Audio Transcription Pipeline

- **Actions**:
  - 实现 yt-dlp 音频提取 (`--extract-audio --audio-format m4a`)
  - 实现 ffmpeg 分块 (60s + 2s overlap)
  - 创建 TranscribeAgent (Claude Agent SDK)
  - 实现重叠感知合并算法
  - 验证时间戳单调性
- **Deliverables**: `audio_extractor.py`, `chunker.py`, `agents/transcribe_agent.py`, `merger.py`
- **Dependencies**: Step 1, ffmpeg, Claude Agent SDK

### Step 5: Output Renderers

- **Actions**:
  - 实现 Segment[] → SRT 渲染器
  - 实现 Segment[] → VTT 渲染器
  - 实现 Segment[] → Markdown 逐字稿渲染器
  - 支持双语输出 (zh+en 单文件格式)
- **Deliverables**: `renderers/srt.py`, `renderers/vtt.py`, `renderers/markdown.py`
- **Dependencies**: Step 3, Step 4

### Step 6: Summarization Agent

- **Actions**:
  - 创建 SummarizeAgent (Claude Agent SDK)
  - 定义 JSON schema: `{key_points[], outline[], entities[], timestamps[]}`
  - 实现 summary.md + summary.json 输出
- **Deliverables**: `agents/summarize_agent.py`, `schemas/summary_schema.json`
- **Dependencies**: Step 5

### Step 7: CLI & Skill Integration

- **Actions**:
  - 实现 CLI 入口 (`python -m bilibili_subtitle`)
  - 创建 SKILL.md (Claude Code skill 定义)
  - 实现缓存/恢复机制
  - 添加 cookies 支持
- **Deliverables**: `__main__.py`, `SKILL.md`, `cache.py`
- **Dependencies**: Step 6

### Step 8: Testing Suite

- **Actions**:
  - 单元测试: converters, renderers, merge algorithm
  - 契约测试: agent JSON schema 验证
  - 集成测试: recorded fixtures
  - E2E 测试: behind `--run-e2e` flag
- **Deliverables**: `tests/` directory
- **Dependencies**: Step 7

---

## Technical Considerations

- **字幕语言 ID 映射**: B站/yt-dlp 实际输出的语言 ID 可能与预期不同，需实现映射层并在 `--verbose` 模式下记录可用轨道
- **双语输出格式**: `zh+en` 模式生成单个双语字幕文件，每条字幕同时显示中英文
- **Path B 合并算法**: 使用 Levenshtein 相似度 (阈值 0.8) 检测重叠，保留 chunk N 版本，调整 chunk N+1 起始时间
- **时间戳单调性**: 强制递增时间戳，允许间隙，仅在重叠区域去重
- **摘要时间戳引用**: 格式 `{start_ms, end_ms, segment_indices[]}`
- **缓存安全**: 不缓存 cookies，仅缓存派生产物；URL 中的 token 需脱敏

---

## Risk Management

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| B站 API/格式变化 | High | Medium | yt-dlp 优先，fallback 策略，清晰诊断信息 |
| 多模态转写可用性/限制 | Medium | Medium | 分块处理，缓存，可恢复运行 |
| 时间戳漂移/合并伪影 | Medium | Medium | 重叠策略 + 验证 + 问题区域重处理 |
| 速率限制 | Medium | High | 指数退避，max_workers=2，元数据缓存 |
| TOS/政策风险 | High | Low | 无批量爬取，仅用户提供认证 |
| Secrets 泄露 | High | Low | 不记录 cookies，安全存储 |

---

## Acceptance Criteria

- [ ] Path A: 输出 SRT/VTT 匹配 golden files (时间戳保留且有效)
- [ ] Path B: 生成严格递增时间戳的 SRT/VTT，跨 chunk 偏移正确
- [ ] 摘要输出符合 schema，引用逐字稿中的时间戳/章节

---

## Design Contributors

| CLI | Key Contributions |
|-----|-------------------|
| Claude | 架构图设计，校对环节强调，多种摘要格式 |
| Codex | 分块策略 (60s+2s)，Segment 数据模型，测试策略，合并算法细节 |
| Gemini | (未配置) |
| OpenCode | (超时) |

---

## Appendix

### Clarification Summary

```
Readiness Score: 88/100

Dimensions:
- Problem Clarity: 24/30 ✓ (新功能，明确业务价值)
- Functional Scope: 20/25 ✓ (多个相关组件)
- Success Criteria: 18/20 ✓ (自动化测试)
- Constraints: 14/15 ✓ (平台限制/合规)
- Priority/MVP: 9/10 ✓ (完整功能，单次发布)
```

### CLI Interface

```bash
bilibili-subtitle <URL> [OPTIONS]
  --output-dir DIR       Output directory (default: ./output)
  --output-lang LANG     zh|en|zh+en (default: zh)
  --cookies-from-browser BROWSER
  --cookies-file FILE
  --skip-proofread       Skip Claude proofreading
  --skip-summary         Skip summarization
  --cache-dir DIR        Cache directory for resume
  --verbose              Show available subtitle tracks
```

### Output Files Structure

```
output/
├── {video_id}.zh.srt          # 中文字幕
├── {video_id}.zh.vtt          # 中文字幕 (VTT)
├── {video_id}.zh+en.srt       # 双语字幕 (if --output-lang zh+en)
├── {video_id}.transcript.md   # 逐字稿
├── {video_id}.summary.md      # 摘要 (Markdown)
└── {video_id}.summary.json    # 摘要 (JSON)
```

### Alternative Approaches Considered

1. **Whisper 本地转写**: 考虑使用 OpenAI Whisper 本地模型，但选择 Claude Agent SDK 以保持一致性和更好的中文支持
2. **B站官方 API**: 考虑直接调用 B站 player API，但选择 yt-dlp 优先以获得更好的稳定性和社区支持
3. **实时流式转写**: 考虑流式处理长视频，但选择分块方式以简化实现和错误恢复
